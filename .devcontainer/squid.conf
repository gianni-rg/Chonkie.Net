#
# SQUID CONFIGURATION FILE FOR AI CODE ASSISTANTS
#
# This is a strict "allow-list" configuration. It will:
# 1. Define an Access Control List (ACL) of allowed AI service domains.
# 2. Block ALL other internet traffic.
#

# --- 1. Standard Port Definitions ---
acl SSL_ports port 443
acl Safe_ports port 80       # For http
acl Safe_ports port 443      # For https
acl Safe_ports port 21       # For FTP
acl Safe_ports port 1025-65535  # Unprivileged ports
acl CONNECT method CONNECT

# --- 2. The Allow-List ACL (ai_services_domains) ---
# Define all domains and subdomains required for the AI services.
# Using ".domain.com" allows all subdomains (e.g., api.github.com)

# GitHub & GitHub Copilot
acl ai_services_domains dstdomain .github.com
acl ai_services_domains dstdomain .githubusercontent.com
acl ai_services_domains dstdomain .githubassets.com

# OpenAI (Direct API)
acl ai_services_domains dstdomain .openai.com

# Azure & Microsoft Services
acl ai_services_domains dstdomain .openai.azure.com
acl ai_services_domains dstdomain .microsoft.com
acl ai_services_domains dstdomain .microsoftonline.com
acl ai_services_domains dstdomain .azure.com
acl ai_services_domains dstdomain .live.com
acl ai_services_domains dstdomain .msftauth.net
acl ai_services_domains dstdomain .msftconnecttest.com

# Google (Gemini, Vertex AI, Google AI Studio)
acl ai_services_domains dstdomain .googleapis.com           # Main API endpoint
acl ai_services_domains dstdomain .google.com               # For OAuth/authentication
acl ai_services_domains dstdomain .ai.google.dev            # AI Studio
acl ai_services_domains dstdomain .generativelanguage.dev   # Gemini API
acl ai_services_domains dstdomain .gstatic.com              # Google static content

# Anthropic (Claude)
acl ai_services_domains dstdomain .anthropic.com

# Hugging Face (often used for models/tools)
acl ai_services_domains dstdomain .huggingface.co
acl ai_services_domains dstdomain .hf.co
acl ai_services_domains dstdomain .hf.space

# --- 3. Development Dependencies ---

# NuGet & .NET
acl ai_services_domains dstdomain .nuget.org
acl ai_services_domains dstdomain .azure.net               # NuGet CDN
acl ai_services_domains dstdomain .azureedge.net           # NuGet CDN

# NPM & Node.js
acl ai_services_domains dstdomain .npmjs.org
acl ai_services_domains dstdomain .npmjs.com
acl ai_services_domains dstdomain .nodejs.org

# VS Code Marketplace & Extensions
acl ai_services_domains dstdomain marketplace.visualstudio.com
acl ai_services_domains dstdomain .vo.msecnd.net             # VS Code extension download CDN
acl ai_services_domains dstdomain .vscode-cdn.net
acl ai_services_domains dstdomain .visualstudio.com
acl ai_services_domains dstdomain update.code.visualstudio.com

# Package repositories
acl ai_services_domains dstdomain .debian.org
acl ai_services_domains dstdomain .ubuntu.com
acl ai_services_domains dstdomain deb.nodesource.com

# Certificate authorities
acl ai_services_domains dstdomain .letsencrypt.org
acl ai_services_domains dstdomain .digicert.com

# --- 4. Access Rules (Applied in order) ---

# Deny requests to non-standard ports
http_access deny !Safe_ports

# Deny CONNECT requests to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost (for internal container communication)
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src 10.0.0.0/8
http_access allow localnet

# Allow our AI services allow-list
http_access allow ai_services_domains

# Finally, block ALL other traffic
http_access deny all

# --- 5. Squid Server Configuration ---
# The port Squid will listen on
http_port 3128

# Set a path for core dumps
coredump_dir /var/spool/squid

# Cache settings
cache_dir ufs /var/spool/squid 100 16 256
maximum_object_size 50 MB

# Enable logging to debug denied requests
# You can check this log to find domains you may need to add.
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Don't cache certain requests
acl QUERY urlpath_regex cgi-bin \?
cache deny QUERY

# Refresh patterns for caching
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Squid Proxy Configuration for Dev Container Network Filtering
# This configuration allows only whitelisted domains for security

# Basic proxy settings
http_port 3128

# Access control lists
acl localnet src 172.16.0.0/12  # Docker/Podman network range
acl localnet src 10.0.0.0/8     # Additional private network
acl localnet src fc00::/7       # IPv6 private range
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 1025-65535  # unprivileged ports
acl CONNECT method CONNECT

# Allowed domains from file
acl allowed_domains dstdomain "/etc/squid/allowed-domains.txt"

# Access rules - order matters!
# Deny requests to non-safe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# Allow local network to access allowed domains
http_access allow localnet allowed_domains

# Deny everything else
http_access deny all

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log /var/log/squid/store.log

# Cache settings
cache_dir ufs /var/spool/squid 1000 16 256
maximum_object_size 50 MB
cache_mem 256 MB

# DNS settings
dns_nameservers 8.8.8.8 1.1.1.1

# Performance tuning
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Privacy settings (remove identifying headers)
forwarded_for delete
request_header_access X-Forwarded-For deny all
request_header_access Via deny all

# Error page customization
error_directory /usr/share/squid/errors/en

# Coredump directory
coredump_dir /var/spool/squid
